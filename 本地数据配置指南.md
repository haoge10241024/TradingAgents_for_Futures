# 本地数据配置指南

## 📊 数据说明

本系统使用本地数据库存储期货历史数据，包括：
- 基差数据 (basis)
- 库存仓单数据 (inventory & receipt)
- 持仓席位数据 (positioning)
- 技术分析数据 (technical_analysis)
- 期限结构数据 (term_structure)

## 🗂️ 数据目录结构

```
qihuo/database/
├── basis/              # 基差数据（期货-现货价差）
│   ├── CU/            # 铜
│   ├── AL/            # 铝
│   ├── RB/            # 螺纹钢
│   └── ...            # 其他品种
├── inventory/          # 库存数据
│   ├── CU.csv
│   ├── AL.csv
│   └── ...
├── receipt/            # 仓单数据
│   ├── CU.csv
│   ├── AL.csv
│   └── ...
├── positioning/        # 持仓席位数据
│   ├── CU/
│   ├── AL/
│   └── ...
├── technical_analysis/ # 技术分析数据（K线、指标等）
│   ├── CU.csv
│   ├── AL.csv
│   └── ...
└── term_structure/     # 期限结构数据
    ├── CU.csv
    ├── AL.csv
    └── ...
```

## 🔧 数据路径配置

### 方法1：使用默认相对路径（推荐）

系统默认配置使用相对路径，无需修改：

```json
// 期货TradingAgents系统_配置文件.json
{
  "paths": {
    "data_root_dir": "./qihuo/database",
    "results_dir": "./qihuo/trading_agents_results",
    "logs_dir": "./qihuo/logs",
    "cache_dir": "./qihuo/cache"
  }
}
```

这种配置的优点：
- ✅ 跨平台兼容（Windows/macOS/Linux）
- ✅ 可随项目移动
- ✅ 适合GitHub分享

### 方法2：使用绝对路径

如果需要自定义数据位置：

```json
{
  "paths": {
    // Windows示例
    "data_root_dir": "D:/期货数据/database",
    
    // macOS/Linux示例
    "data_root_dir": "/Users/username/futures_data/database"
  }
}
```

**注意**：使用绝对路径时，确保：
1. 路径使用正斜杠 `/` 或双反斜杠 `\\`
2. 路径确实存在
3. 程序有读写权限

### 方法3：使用环境变量

最灵活的方式：

```bash
# 设置环境变量
export FUTURES_DATA_DIR="/path/to/data"
```

然后在配置中引用：

```python
# config.py
import os
DATA_ROOT_DIR = os.getenv('FUTURES_DATA_DIR', './qihuo/database')
```

## 📥 获取历史数据

### 选项1：自动下载（推荐）

系统内置数据下载功能，首次运行时自动获取：

```bash
# 运行数据更新器
python unified_futures_data_updater.py

# 或在Streamlit界面中点击"数据更新"按钮
```

数据来源：
- **AkShare**：免费开源的金融数据接口
- **交易所官网**：上期所、大商所、郑商所、能源中心

下载时间：
- 首次完整下载：10-30分钟
- 后续增量更新：2-5分钟

### 选项2：使用GitHub上的示例数据

本仓库包含部分示例数据，可直接使用：

```bash
# 克隆仓库后，数据已在 qihuo/database/ 目录下

# 包含的数据：
- 主要品种的最近90天数据
- 基差、库存、持仓、技术分析、期限结构
- 约10-15个常用品种
```

**示例数据特点**：
- ✅ 开箱即用，无需下载
- ✅ 数据完整，可运行所有分析
- ⚠️ 仅包含近期数据（90天）
- ⚠️ 不包含全部品种

### 选项3：导入自己的数据

如果您有历史数据，可以按以下格式导入：

#### 基差数据格式

```csv
date,futures_price,spot_price,basis,basis_rate
2024-01-01,50000,49500,-500,-0.01
2024-01-02,50100,49600,-500,-0.01
```

#### 库存数据格式

```csv
date,inventory,change,change_rate
2024-01-01,100000,1000,0.01
2024-01-02,101000,1000,0.01
```

#### 持仓数据格式

```csv
date,long_position,short_position,net_position
2024-01-01,100000,95000,5000
2024-01-02,102000,96000,6000
```

#### 技术分析数据格式

```csv
date,open,high,low,close,volume,amount
2024-01-01,50000,50500,49800,50200,100000,5010000000
```

将CSV文件放入对应目录即可。

## 🔄 数据更新

### 自动更新

建议每天盘后更新数据：

```bash
# 手动运行
python unified_futures_data_updater.py

# 或使用计划任务（Linux/macOS）
crontab -e
# 添加：每天下午4点更新
0 16 * * 1-5 cd /path/to/project && python unified_futures_data_updater.py
```

### 增量更新

系统智能识别已有数据，只下载新数据：

```python
# 自动增量更新
from modules import basis_updater, inventory_updater

# 只更新最近7天的数据
updater.update_recent_data(days=7)
```

### 数据清理

定期清理过期数据节省空间：

```bash
# 只保留最近365天的数据
python qihuo/scripts/clean_old_data.py --days 365
```

## 📤 数据上传到GitHub

### 可以上传的数据

本项目已配置`.gitignore`，**示例数据可以上传**：

```gitignore
# 排除个人数据和缓存
qihuo/database/backups/     # 备份文件不上传
qihuo/database/cache/       # 缓存不上传
qihuo/database/*.json       # 临时JSON不上传

# 允许上传CSV数据文件
!qihuo/database/**/*.csv
```

**建议上传的数据**：
- ✅ 主要品种的90天数据
- ✅ 数据结构示例
- ✅ 测试用数据

**不建议上传的数据**：
- ❌ 完整历史数据（文件过大）
- ❌ 个人分析结果
- ❌ 备份文件

### 数据上传步骤

```bash
# 1. 准备示例数据（只保留部分）
python scripts/prepare_sample_data.py

# 2. 检查数据大小
du -sh qihuo/database/

# 3. 如果小于100MB，可以上传
git add qihuo/database/
git commit -m "Add sample futures data"
git push
```

### 大文件处理

如果数据超过100MB，使用Git LFS：

```bash
# 安装Git LFS
git lfs install

# 追踪大型CSV文件
git lfs track "qihuo/database/**/*.csv"

# 提交
git add .gitattributes
git add qihuo/database/
git commit -m "Add data with LFS"
git push
```

## ✅ 验证数据

### 检查数据完整性

```python
# 运行验证脚本
python qihuo/scripts/diagnose_data.py

# 输出示例：
# ✓ 基差数据: 45/52 品种完整
# ✓ 库存数据: 38/52 品种完整
# ✓ 持仓数据: 52/52 品种完整
# ✓ 技术数据: 52/52 品种完整
```

### 查看数据状态

在Streamlit界面中：
1. 点击侧边栏"数据状态"
2. 查看各品种数据覆盖情况
3. 点击"刷新"更新状态

## 🛠️ 数据问题排查

### 问题1：找不到数据文件

**症状**：`FileNotFoundError: [Errno 2] No such file or directory`

**解决**：
```bash
# 1. 检查路径配置
# 2. 确保数据目录存在
mkdir -p qihuo/database/{basis,inventory,positioning,technical_analysis,term_structure}

# 3. 运行数据下载
python unified_futures_data_updater.py
```

### 问题2：数据格式错误

**症状**：`ValueError: could not convert string to float`

**解决**：
```python
# 检查CSV文件编码和格式
import pandas as pd
df = pd.read_csv('qihuo/database/inventory/CU.csv', encoding='utf-8')
print(df.head())
print(df.dtypes)
```

### 问题3：数据更新失败

**症状**：API请求超时或失败

**解决**：
```bash
# 1. 检查网络连接
ping akshare.pro

# 2. 使用代理（如果需要）
export HTTP_PROXY=http://proxy.example.com:8080

# 3. 减小并发数
# 在配置中设置：
"max_concurrent_processes": 2
```

### 问题4：数据占用空间大

**症状**：磁盘空间不足

**解决**：
```bash
# 1. 查看数据大小
du -sh qihuo/database/*

# 2. 清理备份文件
rm -rf qihuo/database/backups/*

# 3. 只保留必要品种
python scripts/keep_essential_commodities.py
```

## 📊 数据质量

### 数据来源可靠性

| 数据类型 | 来源 | 延迟 | 可靠性 |
|---------|------|------|--------|
| 技术数据 | AkShare | T+0 | ⭐⭐⭐⭐⭐ |
| 库存数据 | 交易所官网 | T+1 | ⭐⭐⭐⭐⭐ |
| 持仓数据 | 交易所官网 | T+1 | ⭐⭐⭐⭐⭐ |
| 基差数据 | 计算得出 | T+1 | ⭐⭐⭐⭐ |
| 新闻数据 | 多源聚合 | 实时 | ⭐⭐⭐⭐ |

### 数据更新频率

- **日内数据**：每小时更新（期货交易时段）
- **日线数据**：每日收盘后更新
- **周度数据**：每周五更新
- **月度数据**：每月末更新

## 🔗 相关脚本

```bash
# 数据更新
python unified_futures_data_updater.py

# 数据诊断
python qihuo/scripts/diagnose_data.py

# 导出数据
python qihuo/scripts/export_inventory.py

# 构建数据库
python qihuo/scripts/build_inventory_database.py
```

## 📚 下一步

配置完数据后：
1. 阅读 [快速开始指南](快速开始指南.md)
2. 运行系统测试分析
3. 查看 [使用文档](README.md)

---

**提示**：如果遇到数据问题，请先查看 `qihuo/logs/` 下的日志文件。

